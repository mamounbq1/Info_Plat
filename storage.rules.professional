rules_version = '2';

/**
 * ðŸ”’ PROFESSIONAL FIREBASE STORAGE SECURITY RULES
 * 
 * Architecture:
 * - Custom Claims in token (set by Cloud Functions)
 * - Role-based access control (admin, teacher, student)
 * - File type validation
 * - Size limits per file type
 * - Organized folder structure
 * 
 * Created: 2025-11-01
 */

service firebase.storage {
  match /b/{bucket}/o {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin (from custom claims)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    // Check if user is teacher (from custom claims)
    function isTeacher() {
      return isAuthenticated() && request.auth.token.role == 'teacher';
    }
    
    // Check if user is teacher or admin
    function isTeacherOrAdmin() {
      return isAdmin() || isTeacher();
    }
    
    // Check if user is approved
    function isApproved() {
      return isAuthenticated() && request.auth.token.approved == true;
    }
    
    // Validate image file type
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Validate document file type
    function isDocument() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.*') ||
             request.resource.contentType.matches('application/vnd.ms-.*') ||
             request.resource.contentType.matches('text/.*');
    }
    
    // Validate video file type
    function isVideo() {
      return request.resource.contentType.matches('video/.*');
    }
    
    // Check file size limit (in bytes)
    function isUnderSize(maxSizeInMB) {
      return request.resource.size < maxSizeInMB * 1024 * 1024;
    }
    
    
    // ========================================
    // DEFAULT RULE: DENY ALL
    // ========================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
    
    
    // ========================================
    // COURSES - Thumbnails & Content
    // ========================================
    // Teachers and admins can upload course thumbnails
    // Max size: 5MB, Images only
    match /courses/{courseId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacherOrAdmin() && 
                      isApproved() &&
                      isImage() && 
                      isUnderSize(5);
    }
    
    
    // ========================================
    // COURSE MATERIALS - Documents & Files
    // ========================================
    // Teachers and admins can upload course materials (PDFs, DOCs, etc.)
    // Max size: 20MB, Documents only
    match /course-materials/{courseId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacherOrAdmin() && 
                      isApproved() &&
                      isDocument() && 
                      isUnderSize(20);
    }
    
    
    // ========================================
    // GALLERY - School Photos & Events
    // ========================================
    // Public read, admin-only write/delete
    // Max size: 10MB, Images only
    match /gallery/{imageId} {
      allow read: if true; // Public gallery
      allow create, update: if isAdmin() && 
                               isImage() && 
                               isUnderSize(10);
      allow delete: if isAdmin(); // Admin can delete any image
    }
    
    
    // ========================================
    // NEWS & ANNOUNCEMENTS - Article Images
    // ========================================
    // Public read, admin-only write/delete
    // Max size: 5MB, Images only
    match /news/{imageId} {
      allow read: if true; // Public news
      allow create, update: if isAdmin() && 
                               isImage() && 
                               isUnderSize(5);
      allow delete: if isAdmin();
    }
    
    match /announcements/{announcementId}/{allPaths=**} {
      allow read: if true; // Public announcements
      allow create, update: if isAdmin() && 
                               isImage() && 
                               isUnderSize(5);
      allow delete: if isAdmin();
    }
    
    
    // ========================================
    // TESTIMONIALS - Avatar Images
    // ========================================
    // Public read, admin-only write/delete
    // Max size: 2MB, Images only
    match /testimonials/{imageId} {
      allow read: if true; // Public testimonials
      allow create, update: if isAdmin() && 
                               isImage() && 
                               isUnderSize(2);
      allow delete: if isAdmin();
    }
    
    
    // ========================================
    // EVENTS - Event Cover Images
    // ========================================
    // Public read, admin-only write
    // Max size: 5MB, Images only
    match /events/{eventId}/{allPaths=**} {
      allow read: if true; // Public events
      allow write: if isAdmin() && 
                      isImage() && 
                      isUnderSize(5);
    }
    
    
    // ========================================
    // CLUBS - Club Photos & Media
    // ========================================
    // Public read, admin-only write
    // Max size: 5MB, Images only
    match /clubs/{clubId}/{allPaths=**} {
      allow read: if true; // Public clubs
      allow write: if isAdmin() && 
                      isImage() && 
                      isUnderSize(5);
    }
    
    
    // ========================================
    // HERO SECTION - Homepage Backgrounds
    // ========================================
    // Public read, admin-only write
    // Max size: 10MB, Images only (can be large for hero backgrounds)
    match /hero/{imageId} {
      allow read: if true; // Public homepage
      allow write: if isAdmin() && 
                      isImage() && 
                      isUnderSize(10);
    }
    
    
    // ========================================
    // ABOUT PAGE - Section Images
    // ========================================
    // Public read, admin-only write
    // Max size: 5MB, Images only
    match /about/{imageId} {
      allow read: if true; // Public about page
      allow write: if isAdmin() && 
                      isImage() && 
                      isUnderSize(5);
    }
    
    
    // ========================================
    // USER PROFILES - Avatars & Profile Photos
    // ========================================
    // Users can upload their own profile photo
    // Max size: 2MB, Images only
    match /profiles/{userId}/{allPaths=**} {
      allow read: if isAuthenticated(); // Authenticated users can see profiles
      allow write: if isAuthenticated() && 
                      (request.auth.uid == userId || isAdmin()) &&
                      isImage() && 
                      isUnderSize(2);
    }
    
    
    // ========================================
    // STUDENT SUBMISSIONS - Exercise/Quiz Attachments
    // ========================================
    // Students can upload their own submissions
    // Max size: 10MB, Documents and images
    match /submissions/{userId}/{allPaths=**} {
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isTeacherOrAdmin());
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      (isImage() || isDocument()) && 
                      isUnderSize(10);
    }
    
    
    // ========================================
    // SITE SETTINGS - Logo, Favicon, etc.
    // ========================================
    // Public read, admin-only write/delete
    // Max size: 2MB, Images only
    match /site-settings/{imageId} {
      allow read: if true; // Public site assets
      allow create, update: if isAdmin() && 
                               isImage() && 
                               isUnderSize(2);
      allow delete: if isAdmin();
    }
    
    
    // ========================================
    // BACKWARD COMPATIBILITY
    // ========================================
    // Old gallery path (kept for existing images)
    match /gallery-images/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
