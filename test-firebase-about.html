<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Firebase - Page About</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #00d9ff;
      border-bottom: 2px solid #00d9ff;
      padding-bottom: 10px;
    }
    .test-section {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .test-title {
      color: #ffd700;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .log {
      background: #0f0f23;
      border-left: 3px solid #00d9ff;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    .success {
      border-left-color: #00ff88;
      color: #00ff88;
    }
    .error {
      border-left-color: #ff4757;
      color: #ff4757;
    }
    .warning {
      border-left-color: #ffd700;
      color: #ffd700;
    }
    .info {
      border-left-color: #00d9ff;
      color: #00d9ff;
    }
    button {
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #00b8d4;
    }
    button:active {
      transform: scale(0.98);
    }
    pre {
      background: #0f0f23;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status-pending { background: #ffd700; color: #1a1a2e; }
    .status-success { background: #00ff88; color: #1a1a2e; }
    .status-error { background: #ff4757; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Test Firebase - Page About Editor</h1>
    
    <div class="test-section">
      <div class="test-title">ğŸ“Š Ã‰tat des Tests</div>
      <div id="status">
        <span class="status-badge status-pending">En attente...</span>
      </div>
    </div>

    <div class="test-section">
      <div class="test-title">ğŸ® Actions</div>
      <button onclick="runAllTests()">â–¶ï¸ Lancer tous les tests</button>
      <button onclick="testFirebaseConnection()">ğŸ”¥ Test Connexion Firebase</button>
      <button onclick="testReadAboutPage()">ğŸ“– Test Lecture About</button>
      <button onclick="testFirestoreRules()">ğŸ›¡ï¸ Test RÃ¨gles Firestore</button>
      <button onclick="clearLogs()">ğŸ—‘ï¸ Effacer les logs</button>
    </div>

    <div class="test-section">
      <div class="test-title">ğŸ“ Console de Test</div>
      <div id="logs"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Configuration Firebase (depuis votre projet)
    const firebaseConfig = {
      apiKey: "AIzaSyC8aXTNBM5Jm3RiFqWqvIBCCHk-RYvX6E0",
      authDomain: "eduinformatique-6e803.firebaseapp.com",
      projectId: "eduinformatique-6e803",
      storageBucket: "eduinformatique-6e803.firebasestorage.app",
      messagingSenderId: "739672269524",
      appId: "1:739672269524:web:cd9e1a1c9c3dd91fd03ce9"
    };

    let app, db;
    
    window.log = function(message, type = 'info') {
      const logs = document.getElementById('logs');
      const logDiv = document.createElement('div');
      logDiv.className = `log ${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      
      logs.appendChild(logDiv);
      logs.scrollTop = logs.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, message);
    };

    window.clearLogs = function() {
      document.getElementById('logs').innerHTML = '';
      log('ğŸ—‘ï¸ Logs effacÃ©s', 'info');
    };

    window.updateStatus = function(status, type) {
      const statusDiv = document.getElementById('status');
      let badgeClass = 'status-pending';
      if (type === 'success') badgeClass = 'status-success';
      if (type === 'error') badgeClass = 'status-error';
      
      statusDiv.innerHTML = `<span class="status-badge ${badgeClass}">${status}</span>`;
    };

    window.testFirebaseConnection = async function() {
      log('ğŸ”¥ Test 1: Connexion Ã  Firebase...', 'info');
      try {
        if (!app) {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
        }
        log('âœ… Firebase initialisÃ© avec succÃ¨s', 'success');
        log(`ğŸ“¦ Project ID: ${firebaseConfig.projectId}`, 'info');
        return true;
      } catch (error) {
        log(`âŒ Erreur d'initialisation Firebase: ${error.message}`, 'error');
        log(`âŒ Stack: ${error.stack}`, 'error');
        return false;
      }
    };

    window.testReadAboutPage = async function() {
      log('ğŸ“– Test 2: Lecture de la page About depuis Firestore...', 'info');
      try {
        if (!db) {
          log('âš ï¸ Firebase non initialisÃ©, initialisation...', 'warning');
          await testFirebaseConnection();
        }

        log('ğŸ“„ Tentative de lecture: pageContents/about', 'info');
        const docRef = doc(db, 'pageContents', 'about');
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          log('âœ… Document "about" trouvÃ© !', 'success');
          const data = docSnap.data();
          log(`ğŸ“¦ DonnÃ©es rÃ©cupÃ©rÃ©es:`, 'success');
          log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'info');
        } else {
          log('âš ï¸ Document "about" n\'existe pas dans Firestore', 'warning');
          log('ğŸ’¡ C\'est normal si c\'est la premiÃ¨re fois', 'info');
          log('ğŸ’¡ L\'Ã©diteur devrait crÃ©er le document au premier enregistrement', 'info');
        }
        return true;
      } catch (error) {
        log(`âŒ Erreur de lecture: ${error.message}`, 'error');
        log(`âŒ Code: ${error.code}`, 'error');
        
        if (error.code === 'permission-denied') {
          log('ğŸš¨ ERREUR DE PERMISSIONS FIRESTORE !', 'error');
          log('ğŸ“‹ Les rÃ¨gles Firestore n\'autorisent pas la lecture de pageContents', 'error');
          log('ğŸ”§ Solution: DÃ©ployer les rÃ¨gles Firestore avec la rÃ¨gle pageContents', 'warning');
        }
        return false;
      }
    };

    window.testFirestoreRules = async function() {
      log('ğŸ›¡ï¸ Test 3: VÃ©rification des rÃ¨gles Firestore...', 'info');
      try {
        if (!db) {
          await testFirebaseConnection();
        }

        log('ğŸ“ Test lecture publique (sans auth)...', 'info');
        const testRef = doc(db, 'pageContents', 'test-read');
        
        try {
          await getDoc(testRef);
          log('âœ… Lecture autorisÃ©e (rÃ¨gle: allow read: if true)', 'success');
        } catch (error) {
          if (error.code === 'permission-denied') {
            log('âŒ Lecture refusÃ©e - RÃ¨gles non dÃ©ployÃ©es', 'error');
            log('ğŸ”§ Action requise: DÃ©ployer les rÃ¨gles Firestore', 'warning');
            return false;
          }
        }

        log('ğŸ“ Test Ã©criture (devrait Ã©chouer sans auth admin)...', 'info');
        try {
          await setDoc(testRef, { test: true });
          log('âš ï¸ Ã‰criture autorisÃ©e (ATTENTION: rÃ¨gles trop permissives)', 'warning');
        } catch (error) {
          if (error.code === 'permission-denied') {
            log('âœ… Ã‰criture refusÃ©e (rÃ¨gle: allow write: if isAdmin())', 'success');
          }
        }

        return true;
      } catch (error) {
        log(`âŒ Erreur test rÃ¨gles: ${error.message}`, 'error');
        return false;
      }
    };

    window.runAllTests = async function() {
      updateStatus('Tests en cours...', 'pending');
      clearLogs();
      
      log('ğŸš€ DÃ©marrage de la suite de tests complÃ¨te', 'info');
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      
      const results = [];
      
      results.push(await testFirebaseConnection());
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      
      results.push(await testReadAboutPage());
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      
      results.push(await testFirestoreRules());
      log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      
      const success = results.filter(r => r).length;
      const total = results.length;
      
      log(`ğŸ Tests terminÃ©s: ${success}/${total} rÃ©ussis`, success === total ? 'success' : 'error');
      
      if (success === total) {
        updateStatus(`âœ… Tous les tests rÃ©ussis (${success}/${total})`, 'success');
      } else {
        updateStatus(`âŒ Tests Ã©chouÃ©s (${success}/${total})`, 'error');
      }
    };

    // Auto-run au chargement
    log('ğŸ¯ Page de test chargÃ©e', 'success');
    log('ğŸ‘‰ Cliquez sur "Lancer tous les tests" pour commencer', 'info');
  </script>
</body>
</html>
