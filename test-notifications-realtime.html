<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Notifications en Temps R√©el</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #1a73e8;
      margin-top: 0;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #1a73e8;
      padding-bottom: 8px;
    }
    .log {
      background: #f8f9fa;
      border-left: 4px solid #1a73e8;
      padding: 12px;
      margin: 8px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }
    .log.success { border-color: #34a853; background: #e6f4ea; }
    .log.error { border-color: #ea4335; background: #fce8e6; }
    .log.warning { border-color: #fbbc04; background: #fef7e0; }
    .log.info { border-color: #4285f4; background: #e8f0fe; }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    .status.active { background: #34a853; color: white; }
    .status.inactive { background: #ea4335; color: white; }
    .status.pending { background: #fbbc04; color: white; }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #1557b0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .notification-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .notification-item.new {
      border-color: #1a73e8;
      background: #e8f0fe;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin: 8px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .timestamp {
      color: #666;
      font-size: 12px;
    }
    pre {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîî Test Notifications en Temps R√©el</h1>
    <p>Ce test v√©rifie que les notifications Firestore arrivent en temps r√©el.</p>
    
    <div>
      <button onclick="startListeners()">‚ñ∂Ô∏è D√©marrer les Listeners</button>
      <button onclick="stopListeners()">‚èπÔ∏è Arr√™ter les Listeners</button>
      <button onclick="testCreateMessage()">üìß Cr√©er un Message Test</button>
      <button onclick="clearLogs()">üóëÔ∏è Effacer les Logs</button>
    </div>

    <div class="grid">
      <div class="stat-card">
        <div class="stat-label">Messages Pending</div>
        <div class="stat-number" id="messageCount">-</div>
        <div class="timestamp" id="messageTime">En attente...</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="stat-label">Utilisateurs Pending</div>
        <div class="stat-number" id="userCount">-</div>
        <div class="timestamp" id="userTime">En attente...</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <div class="stat-label">Total Notifications</div>
        <div class="stat-number" id="totalCount">-</div>
        <div class="timestamp" id="totalTime">En attente...</div>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>üìä Logs en Direct</h2>
    <div id="logs"></div>
  </div>

  <div class="container">
    <h2>üîî Notifications Re√ßues</h2>
    <div id="notifications"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Configuration Firebase (m√™me que votre app)
    const firebaseConfig = {
      apiKey: "AIzaSyAHT0YIqZAGSp4HWpFX8lq_R7Y4dH_uXDU",
      authDomain: "info-plat.firebaseapp.com",
      projectId: "info-plat",
      storageBucket: "info-plat.firebasestorage.app",
      messagingSenderId: "294278631788",
      appId: "1:294278631788:web:86d26ae61b4f7d32ab17f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let unsubscribeUsers = null;
    let unsubscribeMessages = null;
    let allNotifications = [];

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString('fr-FR');
      const logEntry = document.createElement('div');
      logEntry.className = `log ${type}`;
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      logsDiv.insertBefore(logEntry, logsDiv.firstChild);
      console.log(`[${timestamp}] ${message}`);
    }

    function updateStats(messageCount, userCount) {
      document.getElementById('messageCount').textContent = messageCount;
      document.getElementById('userCount').textContent = userCount;
      document.getElementById('totalCount').textContent = messageCount + userCount;
      
      document.getElementById('messageTime').textContent = `Mis √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;
      document.getElementById('userTime').textContent = `Mis √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;
      document.getElementById('totalTime').textContent = `Mis √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;
    }

    function displayNotifications() {
      const notifDiv = document.getElementById('notifications');
      notifDiv.innerHTML = '';
      
      if (allNotifications.length === 0) {
        notifDiv.innerHTML = '<p style="color: #666;">Aucune notification re√ßue.</p>';
        return;
      }

      allNotifications
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .forEach(notif => {
          const item = document.createElement('div');
          item.className = 'notification-item';
          item.innerHTML = `
            <div><strong>${notif.type === 'message' ? 'üìß Message' : 'üë§ Utilisateur'}</strong></div>
            <div>${notif.message}</div>
            <div class="timestamp">${new Date(notif.timestamp).toLocaleString('fr-FR')}</div>
            <pre>${JSON.stringify(notif.data, null, 2)}</pre>
          `;
          notifDiv.appendChild(item);
        });
    }

    window.startListeners = function() {
      log('üöÄ D√©marrage des listeners Firestore...', 'info');

      // Listener 1: Messages
      try {
        const messagesQuery = query(
          collection(db, 'messages'),
          where('status', '==', 'pending'),
          orderBy('createdAt', 'desc')
        );

        log('üì® Cr√©ation du listener MESSAGES avec query: where(status==pending) + orderBy(createdAt)', 'info');

        unsubscribeMessages = onSnapshot(
          messagesQuery,
          (snapshot) => {
            log(`‚úÖ Snapshot MESSAGES re√ßu: ${snapshot.docs.length} documents`, 'success');
            
            const messages = snapshot.docs.map(doc => {
              const data = doc.data();
              log(`  üìß Message trouv√©: ${data.name} - "${data.subject}"`, 'info');
              return {
                id: `message-${doc.id}`,
                type: 'message',
                message: `Nouveau message: ${data.subject || 'Sans sujet'}`,
                timestamp: data.createdAt,
                data: data
              };
            });

            // Fusionner avec les notifications existantes
            allNotifications = [
              ...allNotifications.filter(n => n.type !== 'message'),
              ...messages
            ];

            const userCount = allNotifications.filter(n => n.type === 'user').length;
            updateStats(messages.length, userCount);
            displayNotifications();
          },
          (error) => {
            log(`‚ùå ERREUR Listener MESSAGES: ${error.message}`, 'error');
            log(`‚ùå Code erreur: ${error.code}`, 'error');
            
            if (error.message.includes('index')) {
              log('üî• INDEX MANQUANT! La requ√™te n√©cessite un index Firestore composite.', 'error');
              log('üìã Solution: firebase deploy --only firestore:indexes', 'warning');
              
              // Extraire le lien de l'erreur
              const match = error.message.match(/https:\/\/[^\s]+/);
              if (match) {
                log(`üîó Cr√©er l'index ici: <a href="${match[0]}" target="_blank">${match[0]}</a>`, 'warning');
              }
            }
          }
        );

        log('‚úÖ Listener MESSAGES cr√©√©', 'success');
      } catch (error) {
        log(`‚ùå Erreur cr√©ation listener MESSAGES: ${error.message}`, 'error');
      }

      // Listener 2: Users
      try {
        const usersQuery = query(
          collection(db, 'users'),
          where('status', '==', 'pending'),
          orderBy('createdAt', 'desc')
        );

        log('üë§ Cr√©ation du listener USERS avec query: where(status==pending) + orderBy(createdAt)', 'info');

        unsubscribeUsers = onSnapshot(
          usersQuery,
          (snapshot) => {
            log(`‚úÖ Snapshot USERS re√ßu: ${snapshot.docs.length} documents`, 'success');
            
            const users = snapshot.docs.map(doc => {
              const data = doc.data();
              log(`  üë§ User trouv√©: ${data.fullName} (${data.email})`, 'info');
              return {
                id: `user-${doc.id}`,
                type: 'user',
                message: `Nouvelle inscription: ${data.fullName}`,
                timestamp: data.createdAt,
                data: data
              };
            });

            // Fusionner avec les notifications existantes
            allNotifications = [
              ...allNotifications.filter(n => n.type !== 'user'),
              ...users
            ];

            const messageCount = allNotifications.filter(n => n.type === 'message').length;
            updateStats(messageCount, users.length);
            displayNotifications();
          },
          (error) => {
            log(`‚ùå ERREUR Listener USERS: ${error.message}`, 'error');
            log(`‚ùå Code erreur: ${error.code}`, 'error');
            
            if (error.message.includes('index')) {
              log('üî• INDEX MANQUANT! La requ√™te n√©cessite un index Firestore composite.', 'error');
              log('üìã Solution: firebase deploy --only firestore:indexes', 'warning');
            }
          }
        );

        log('‚úÖ Listener USERS cr√©√©', 'success');
      } catch (error) {
        log(`‚ùå Erreur cr√©ation listener USERS: ${error.message}`, 'error');
      }

      log('üéâ Les deux listeners sont maintenant actifs et attendent les changements...', 'success');
    };

    window.stopListeners = function() {
      if (unsubscribeMessages) {
        unsubscribeMessages();
        log('‚èπÔ∏è Listener MESSAGES arr√™t√©', 'warning');
      }
      if (unsubscribeUsers) {
        unsubscribeUsers();
        log('‚èπÔ∏è Listener USERS arr√™t√©', 'warning');
      }
    };

    window.testCreateMessage = async function() {
      try {
        log('üìß Cr√©ation d\'un message test...', 'info');
        
        const messageData = {
          name: 'Test User',
          email: 'test@example.com',
          subject: `Test ${Date.now()}`,
          message: 'Ceci est un message de test pour v√©rifier les notifications en temps r√©el.',
          status: 'pending',
          createdAt: new Date().toISOString(),
          timestamp: Date.now()
        };

        const docRef = await addDoc(collection(db, 'messages'), messageData);
        
        log(`‚úÖ Message test cr√©√© avec ID: ${docRef.id}`, 'success');
        log('‚è≥ Le listener devrait le d√©tecter dans quelques secondes...', 'info');
      } catch (error) {
        log(`‚ùå Erreur cr√©ation message: ${error.message}`, 'error');
      }
    };

    window.clearLogs = function() {
      document.getElementById('logs').innerHTML = '';
      log('üóëÔ∏è Logs effac√©s', 'info');
    };

    // Auto-start listeners on page load
    log('üìÑ Page charg√©e. Cliquez sur "D√©marrer les Listeners" pour commencer.', 'info');
    log('üí° Astuce: Ouvrez la console (F12) pour voir plus de d√©tails.', 'info');
  </script>
</body>
</html>
